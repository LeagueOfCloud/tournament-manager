AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31

Parameters:
  SecretVersion:
    Type: String
  SecretArn:
    Type: String
  S3AssetsBucket:
    Type: String
  RestartDBInstanceId:
    Type: String
  TwitchAppSecretArn:
    Type: String

Globals:
  Function:
    Runtime: python3.13
    Environment:
      Variables:
        SECRET_VERSION: !Ref SecretVersion
        DB_HOST: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:host}}"
        DB_PORT: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:port}}"
        DB_USER: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:user}}"
        DB_PASSWORD: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:password}}"
        DB_NAME: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:name}}"
        RIOT_API_KEY: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:riot_api_key}}"
        BUCKET_NAME: !Ref S3AssetsBucket

Resources:          
  ###########################################################
  # NESTED STACKS                                           #
  ###########################################################

  Schedules:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./scheduler.yaml
      Parameters:
        FetchChampionMasteryLambdaArn: !GetAtt FetchPlayerChampionMasteryLambda.Arn
        FetchMatchIDsLambdaArn: !GetAtt FetchMatchHistoryLambda.Arn
        FetchMatchDataLambdaArn: !GetAtt FetchMatchDataLambda.Arn
        FetchPlayerStatsLambdaArn: !GetAtt FetchPlayerStatsLambda.Arn
        ProcessMatchDataLambdaArn: !GetAtt ProcessMatchDataLambda.Arn
        RestartDBInstanceId: !Ref RestartDBInstanceId
  
  Websockets:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./websocket.yaml
      Parameters:
        ConnectionsTable: !GetAtt ConnectionsTable.Arn


  ###########################################################
  # REST-API DEFINITION                                     #
  ###########################################################

  Api:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Ref AWS::StackName
      StageName: prod
      Cors:
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'"
        AllowMethods: "'GET,OPTIONS,DELETE,POST,PATCH,PUT'"
        AllowOrigin: "'*'"
        AllowCredentials: false
      Auth:
        Authorizers:
            ApiTokenAuthorizer:
              FunctionArn: !GetAtt ApiAuthenticatorLambda.Arn
              FunctionPayloadType: REQUEST
              Identity:
                Headers:
                  - Authorization
                ReauthorizeEvery: 1
                
        AddDefaultAuthorizerToCorsPreflight: false
        DefaultAuthorizer: ApiTokenAuthorizer
      EndpointConfiguration:
        Type: REGIONAL

  LambdaRole:
      Type: AWS::IAM::Role
      Properties:
        ManagedPolicyArns:
          - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        AssumeRolePolicyDocument:
          Version: "2012-10-17"
          Statement: 
            - Effect: Allow
              Principal:
                Service: lambda.amazonaws.com
              Action: sts:AssumeRole
        Policies:
          - PolicyName: S3BucketAccess
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - s3:*
                  Resource:
                    - !Sub arn:aws:s3:::${S3AssetsBucket}
                    - !Sub arn:aws:s3:::${S3AssetsBucket}/*
          - PolicyName: DynamoDBAccess
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - dynamodb:*
                  Resource:
                    - !GetAtt ConnectionsTable.Arn
          - PolicyName: SecretsManager
            PolicyDocument:
              Version: "2012-10-17"
              Statement:
                - Effect: Allow
                  Action:
                    - secretsmanager:*
                  Resource:
                    - !Ref TwitchAppSecretArn

  ApiAuthenticatorLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/api-authenticator/src/
      Handler: app.lambda_handler
      Timeout: 30

  ###########################################################
  # DynamoDB                                                #
  ###########################################################

  ConnectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TimeToLiveSpecification:
        AttributeName: TTL
        Enabled: true
      KeySchema:
        - AttributeName: lobbyId
          KeyType: HASH
      AttributeDefinitions:
        - AttributeName: lobbyId
          AttributeType: S
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  ###########################################################
  # PLAYER LAMBDAS                                          #
  ###########################################################
  GetPlayersLambda:
      Type: AWS::Serverless::Function
      Properties:
        CodeUri: lambdas/players/get/src/
        Handler: app.lambda_handler
        Timeout: 30
        Events:
          ApiEndpoint:
            Type: Api
            Properties:
              Path: /players
              Method: GET
              Auth:
                Authorizer: NONE
              RestApiId: !Ref Api

  CreatePlayerLambda:
    Type: AWS::Serverless::Function
    Properties:
      Role: !GetAtt LambdaRole.Arn
      CodeUri: lambdas/players/create/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /players
            Method: POST
            RestApiId: !Ref Api
  
  DeletePlayerLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/players/delete/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /players
            Method: DELETE
            RestApiId: !Ref Api
  
  UpdatePlayerLambda:
    Type: AWS::Serverless::Function
    Properties:
      Role: !GetAtt LambdaRole.Arn
      CodeUri: lambdas/players/update/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /players
            Method: PATCH
            RestApiId: !Ref Api

  ###########################################################
  # RESOURCE GET LAMBDA                                     #
  ###########################################################
  
  ResourceGetLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/resource-get/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpointPlayersSpecific:
          Type: Api
          Properties:
            Path: /players/{id}
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api
        ApiEndpointTeams:
          Type: Api
          Properties:
            Path: /teams
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api
        ApiEndpointTeamsSpecific:
          Type: Api
          Properties:
            Path: /teams/{id}
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api
        ApiEndpointRiotAccountsSpecific:
          Type: Api
          Properties:
            Path: /riot-accounts/{id}
            Method: GET
            RestApiId: !Ref Api
        ApiEndpointProfiles:
          Type: Api
          Properties:
            Path: /profiles
            Method: GET
            RestApiId: !Ref Api
        ApiEndpointProfilesSpecific:
          Type: Api
          Properties:
            Path: /profiles/{id}
            Method: GET
            RestApiId: !Ref Api
        ApiEndpointConfigs:
          Type: Api
          Properties:
            Path: /config
            Method: GET
            RestApiId: !Ref Api
        ApiEndpointSettings:
          Type: Api
          Properties:
            Path: /settings
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api

  ###########################################################
  # RIOT ACCOUNT LAMBDAS                                    #
  ###########################################################

  GetAccountsLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/riot-accounts/get/src
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /riot-accounts
            Method: GET
            RestApiId: !Ref Api

  CreateRiotAccountLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/riot-accounts/create/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /riot-accounts
            Method: POST
            RestApiId: !Ref Api

  DeleteRiotAccountLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/riot-accounts/delete/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /riot-accounts
              Method: DELETE
              RestApiId: !Ref Api
  
  UpdateRiotAccountLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/riot-accounts/update/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /riot-accounts
              Method: PATCH
              RestApiId: !Ref Api

  GetAccountsFromPlayerIdLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/riot-accounts/player-get/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /riot-accounts/player/{player_id}
            Method: GET
            RestApiId: !Ref Api

  ###########################################################
  # TEAM LAMBDAS                                            #
  ###########################################################

  CreateTeamLambda:
    Type: AWS::Serverless::Function
    Properties:
      Role: !GetAtt LambdaRole.Arn
      CodeUri: lambdas/teams/create/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /teams
              Method: POST
              RestApiId: !Ref Api
  
  DeleteTeamLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/teams/delete/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /teams
              Method: DELETE
              RestApiId: !Ref Api
  
  UpdateTeamLambda:
    Type: AWS::Serverless::Function
    Properties:
      Role: !GetAtt LambdaRole.Arn
      CodeUri: lambdas/teams/update/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /teams
            Method: PATCH
            RestApiId: !Ref Api

  ###########################################################
  # MATCH HISTORY LAMBDAS                                   #
  ###########################################################

  FetchMatchHistoryLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/matches/get-match-ids/src/
      Handler: app.lambda_handler
      Timeout: 30
  
  FetchMatchDataLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/matches/get-match-data/src/
      Handler: app.lambda_handler
      Timeout: 30
  
  ProcessMatchDataLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/matches/process-match-data/src/
      Handler: app.lambda_handler
      Timeout: 60

  ###########################################################
  # LEAGUE STATS LAMBDAS                                    #
  ###########################################################

  FetchPlayerStatsLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/player-stats/src/
      Handler: app.lambda_handler
      Timeout: 30

  ###########################################################
  # ACCOUNT CHAMPION MASTERY LAMBDAS                        #
  ###########################################################

  FetchPlayerChampionMasteryLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/champion-mastery/src/
      Handler: app.lambda_handler
      Timeout: 30

  ###########################################################
  # CONFIG LAMBDAS                                          #
  ###########################################################

  CreateOrUpdateConfigLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/config/create-update/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /config
            Method: PUT
            RestApiId: !Ref Api
  
  DeleteConfigLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/config/delete/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /config
              Method: DELETE
              RestApiId: !Ref Api

  ###########################################################
  # TOURNAMENT MATCH LAMBDAS                                #
  ###########################################################

  GetTournamentMatchLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/tournament-matches/get/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /tournament-matches
              Method: GET
              RestApiId: !Ref Api

  CreateTournamentMatchLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/tournament-matches/create/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /tournament-matches
              Method: POST
              RestApiId: !Ref Api

  UpdateTournamentMatchLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/tournament-matches/update/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /tournament-matches
              Method: PATCH
              RestApiId: !Ref Api
  
  DeleteTournamentMatchLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/tournament-matches/delete/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /tournament-matches
              Method: DELETE
              RestApiId: !Ref Api

  ###########################################################
  # PICKEMS LAMBDAS                                         #
  ###########################################################

  PutPickemsLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/pickems/put/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
            Type: Api
            Properties:
              Path: /pickems
              Method: PUT
              RestApiId: !Ref Api

  GetPickemsLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/pickems/get/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /pickems/{id}
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api

  ###########################################################
  # DREAMDRAFT LAMBDAS                                      #
  ###########################################################

  CreateOrUpdateDreamDraftLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/dream-draft/create-update/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /dream-draft
            Method: PUT
            RestApiId: !Ref Api

  GetDreamDraftLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/dream-draft/get/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /dream-draft/{profile_id}
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api

  ###########################################################
  # LEADERBOARD LAMBDAS                                     #
  ###########################################################

  LeaderboardLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/leaderboard/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /leaderboard/{board}
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api

  ###########################################################
  # TOURNAMENT LAMBDAS                                      #
  ###########################################################

  TournamentCreateLobbyLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/tournament/create-lobby/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /tournament/create-lobby/{id}
            Method: POST
            RestApiId: !Ref Api

  TournamentCallbackLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/tournament/callback/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /tournament/callback
            Method: POST
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api

  ###########################################################
  # SCHEDULE LAMBDAS                                        #
  ###########################################################
  
  GetScheduleMatchLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/schedule/get-schedule-match/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /schedule/match/{match_id}
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api

  GetScheduleLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/schedule/get/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /schedule
            Method: GET
            Auth:
              Authorizer: NONE
            RestApiId: !Ref Api

  ###########################################################
  # CHAMP SELECT LAMBDAS                                    #
  ###########################################################

  ChampSelectLobbyCreateLambda:
    Type: AWS::Serverless::Function
    Properties:
      Role: !GetAtt LambdaRole.Arn
      CodeUri: lambdas/champ-select/post/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /champ-select-lobby
            Method: POST
            RestApiId: !Ref Api
      Environment:
        Variables:
          TABLE_NAME: !Ref ConnectionsTable
  
  ChampSelectLobbyGetLambda:
    Type: AWS::Serverless::Function
    Properties:
      Role: !GetAtt LambdaRole.Arn
      CodeUri: lambdas/champ-select/get/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /champ-select-lobby
            Method: GET
            RestApiId: !Ref Api
      Environment:
        Variables:
          TABLE_NAME: !Ref ConnectionsTable

  ###########################################################
  # Live Check                                              #
  ###########################################################
  LiveCheck:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/livecheck/src/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Timeout: 30
      Environment:
        Variables:
          TWITCH_CLIENT_ID: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:twitch_client_id}}"
          TWITCH_CLIENT_SECRET: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:twitch_client_secret}}"
          TWITCH_APP_SECRET_ARN: !Ref TwitchAppSecretArn
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /livecheck
            Method: GET
            RestApiId: !Ref Api

  ###########################################################
  # Admin                                                   #
  ###########################################################
  AdminStatsGetLambda:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/admin/stats/src/
      Handler: app.lambda_handler
      Timeout: 30
      Events:
        ApiEndpoint:
          Type: Api
          Properties:
            Path: /admin/stats
            Method: GET
            RestApiId: !Ref Api
  
  ###########################################################
  # Twitch Token Refresher                                  #
  ###########################################################
  TwitchTokenRefresher:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/twitch-api-token-refresher/src/
      Handler: app.lambda_handler
      Role: !GetAtt LambdaRole.Arn
      Timeout: 30
      Environment:
        Variables:
          TWITCH_CLIENT_ID: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:twitch_client_id}}"
          TWITCH_CLIENT_SECRET: !Sub "{{resolve:secretsmanager:${SecretArn}:SecretString:twitch_client_secret}}"
          TWITCH_APP_SECRET_ARN: !Ref TwitchAppSecretArn
